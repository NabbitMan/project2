<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Wetty - The WebTTY Terminal Emulator</title>

    <style>
        html,
        body {
            height: 100%;
            width: 100%;
            margin: 0px;
        }

        #explorer {
            display: block;
            width: 30%;
            height: 100%;

            position: absolute;
            top: 0;
            left: 0;
            
        }

        #editor_container {
            display: block;
            width: 70%;
            height: 50%;

            position: absolute;
            top: 0;
            right: 0;            
        }

        .editor_body {
            height: 250px;
        }

        #terminal {
            display: block;
            width: 70%;
            height: 50%;

            position: absolute;
            bottom: 0;
            right: 0;
        }
    </style>
    <!-- <link rel="stylesheet" type="text/css" href="/wetty/css/main.css" /> -->
    <link rel="stylesheet" href="/wetty/jquery-ui/css/jquery-ui.min.css" />
    <link rel="stylesheet" href="/wetty/jstree/dist/themes/default/style.min.css" />
    <link rel="stylesheet" href="/wetty/font-awesome/css/font-awesome.css" />
    <!-- <link rel="stylesheet" href="/wetty/css/bootstrap.min.css" /> -->

    <script src="/wetty/hterm_all.js"></script>
    <script src="/wetty/socket.io/socket.io.js"></script>
    <script src="/wetty/wetty.js"></script>
    <script src="/wetty/jquery/jquery.min.js"></script>
    <script src="/wetty/jquery-ui/js/jquery-ui.min.js"></script>
    <!-- <script src="/wetty/js/bootstrap.min.js"></script> -->
    <script src="/wetty/jstree/dist/jstree.min.js"></script>
    <script src="/wetty/src-noconflict/ace.js"></script>
    <script>
            var editors = {};

            var savedata = function (save_button_id) {
                var fileName = save_button_id;
                var fileContents = editors[save_button_id].getSession().getValue();
                console.log(fileName, fileContents);
                $.ajax({
                    url: '/api/savedata',
                    type: 'POST',
                    data: {
                        file: fileName,
                        contents: fileContents
                    },
                    success: function (data) {
                        console.log(data);
                    }
                });
            };

            $.fn.addEditorTab = function(name, tabName, contents) {
                $('ul', this).append('<li><a href="#tab-' + name + '">' + tabName + '</a><span class="ui-icon ui-icon-close" role="presentation"></li>');
                $(this).append('<div id="tab-' + name + '"><div><button id="' + name + '" class="btn btn-sm" onclick="savedata(this.id)"><i class="fa fa-save"></i></button></div><div id="editor-' + name + '" class="editor_body"></div></div>');
                $(this).tabs('refresh');

                var editor = ace.edit("editor-" + name);
                editor.setTheme("ace/theme/monokai");
                editor.getSession().setMode("ace/mode/javascript");
                editor.getSession().setValue(contents);

                return editor;
            };
    
            $(function() {
                var tabs = $('#tabs').tabs();
                

                // var file1Path = "D:/file1.js";
                // var file1Name = "file1.js";
                // var file1Contents = "Dipankar";

                // var file2Path = "D:/file2.js";
                // var file2Name = "file2.js";
                // var file2Contents = "Nag";

                // editors[file1Path] = tabs.addEditorTab(file1Path, file1Name, file1Contents);
                // editors[file2Path] = tabs.addEditorTab(file2Path, file2Name, file2Contents);
                // editors[file2Path] = tabs.addEditorTab(file2Path, file2Name, file2Contents);

                tabs.on('click', 'span.ui-icon-close',  function() {
                    var panelId = $(this).closest('li').remove().attr('aria-controls');
                    var editorId = panelId.replace("tab-", "editor-");

                    $('div[id="' + editorId + '"]').remove();
                    $('div[id="' + panelId + '"]').remove();

                    editors[editorId.replace("editor-", "")].destroy();
                    // editors.splice(editors.indexOf(panelId.replace("tab-", "")), 1);
                    // console.log(editors.indexOf(panelId.replace("tab-", "")));
                    delete editors[panelId.replace("tab-", "")];

                    tabs.tabs('refresh');
                });
    
                $('#jstreejson').jstree({
                    'core': {
                        'data': {
                            'url': '/api/tree',
                            'data': function(node) {
                                return { 'id': node.id };
                            }
                        }
                    }
                })
                .on('select_node.jstree', function(e, item) {
                    $.ajax({
                        url: '/api/resource',
                        data: {
                            resource: item.node.id
                        },
                        type: 'GET',
                        success: function (data) {
                            // $("#editor").text(data);
                            // editor.setValue(data, -1);
                            // console.log(editor.getSelectedText());
                            console.log(editors);
                            console.log(item.node.id, item.node.text);
                            if (typeof editors[item.node.id] === 'undefined') {
                                editors[item.node.id] = tabs.addEditorTab(item.node.id, item.node.text, data);
                            }
                            else {
                                console.log("Tab exists");
                            }
                            $('a[href="#tab-' + item.node.id + '"]').click();
                        }
                    });
                });
    
                $('#refresh_explorer').on('click', function() {
                    $('#jstreejson').jstree('refresh');
                });
            });
        </script>
</head>

<body>
    <div id="explorer">
        <div><b>Project Explorer</b>
            <button id="refresh_explorer" class="btn btn-sm"><i class="fa fa-refresh"></i></button>
        </div>
        <div id="jstreejson"></div>
    </div>
    <div id="editor_container">
        <div id="tabs">
            <ul></ul>
        </div>
    </div>
    <div id="terminal"></div>
    <!-- <script src="/wetty/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script> -->
    <!-- <script>
        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/solarized_light");
        editor.session.setMode("ace/mode/java");
    </script> -->
    
</body>

</html>
